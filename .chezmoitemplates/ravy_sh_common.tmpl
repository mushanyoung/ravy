{{- /* Common bash/zsh env + PATH setup. */ -}}

# --- PATH helpers -------------------------------------------------------------
_ravy_prepend_path() {
  # Usage: _ravy_prepend_path /some/dir
  [ -n "${1:-}" ] || return 0
  [ -d "$1" ] || return 0
  case ":$PATH:" in
    *":$1:"*) : ;;
    *) PATH="$1:$PATH" ;;
  esac
}

# Resolve RAVY_HOME:
# - Prefer chezmoi source-path when available
# - Fall back to the default source dir used by chezmoi
# - Fall back to legacy ~/.ravy
if command -v chezmoi >/dev/null 2>&1; then
  RAVY_HOME="$(chezmoi source-path 2>/dev/null || true)"
fi
if [ -z "${RAVY_HOME:-}" ] && [ -d "$HOME/.local/share/chezmoi" ]; then
  RAVY_HOME="$HOME/.local/share/chezmoi"
fi
if [ -z "${RAVY_HOME:-}" ]; then
  RAVY_HOME="$HOME/.ravy"
fi
export RAVY_HOME

# User scripts
_ravy_prepend_path "$RAVY_HOME/bin"
_ravy_prepend_path "$HOME/bin"
_ravy_prepend_path "$HOME/.local/bin"
_ravy_prepend_path "$HOME/.bun/bin"

# Homebrew / Linuxbrew detection (sets env + updates PATH/MANPATH/INFOPATH)
if [ -z "${RAVY_SKIP_BREW:-}" ]; then
  for brewprefix in /opt/homebrew /usr/local /home/linuxbrew/.linuxbrew "$HOME/.brew" "$HOME/.linuxbrew"; do
    if [ -x "$brewprefix/bin/brew" ]; then
      HOMEBREW_PREFIX="$brewprefix"
      HOMEBREW_CELLAR="$brewprefix/Cellar"
      HOMEBREW_REPOSITORY="$brewprefix/Homebrew"
      HOMEBREW_NO_ANALYTICS=1
      export HOMEBREW_PREFIX HOMEBREW_CELLAR HOMEBREW_REPOSITORY HOMEBREW_NO_ANALYTICS

      if [ -d "$HOMEBREW_PREFIX/share/man" ]; then
        MANPATH="${MANPATH:-}"
        export MANPATH="$HOMEBREW_PREFIX/share/man${MANPATH:+:$MANPATH}"
      fi
      if [ -d "$HOMEBREW_PREFIX/share/info" ]; then
        INFOPATH="${INFOPATH:-}"
        export INFOPATH="$HOMEBREW_PREFIX/share/info${INFOPATH:+:$INFOPATH}"
      fi

      if [ -d "$brewprefix/opt/ruby/bin" ]; then
        _ravy_prepend_path "$brewprefix/opt/ruby/bin"
      fi

      _ravy_prepend_path "$HOMEBREW_PREFIX/sbin"
      _ravy_prepend_path "$HOMEBREW_PREFIX/bin"
      break
    fi
  done
fi

export PATH

{{ template "ravy_env_common.tmpl" (dict "shell" "sh") }}
