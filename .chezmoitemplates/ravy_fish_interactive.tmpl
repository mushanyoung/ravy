{{- /* Fish interactive setup: prompt/hooks/env + functions/aliases. Requires interactive shell. */ -}}
# Disable fish_greeting message
set fish_greeting

{{ template "ravy_env_common.tmpl" (dict "shell" "fish") }}

if set -q CURSOR_AGENT || set -q CURSOR_TRACE_ID
    if command -v cursor
        . (cursor --locate-shell-integration-path fish)
    end
end

# starship
if command -v starship &>/dev/null
    starship init fish | source
end

# direnv
if command -v direnv &>/dev/null
    direnv hook fish | source
end

# atuin
if command -v atuin &>/dev/null
    atuin init fish | source 2>/dev/null
end

# functions
function imv
    set -l src
    for src in $argv
        if test -e $src
            set -g __imv__ $src
            vared __imv__
            test $src != "$__imv__"
            and mkdir -p (dirname $__imv__)
            and mv $src $__imv__
        else
            echo "$src does not exist"
        end
    end
end

function lines
    if test (count $argv) -gt 0
        echo $argv | xargs -n1
    end
    if not isatty stdin
        cat 1>| xargs -n1
    end
end

# cd ..
function d
    cd ..
end

# edit command in path
function ep --wraps="command -v"
    if set -l exe (command -v $argv[1])
        echo $EDITOR $exe
        $EDITOR $exe
    end
end

# history statistics
function history-stat
    history | awk '{print $1}' | sort | uniq -c | sort -n -r | head
end

# eza wrapper
function ls
    if command -v eza >/dev/null
        command eza --icons --group-directories-first --git --color $argv
    else
        command ls $argv
    end
end

function du --wraps='du' --description 'gdu or du'
    if type -q gdu
        command gdu
    else
        command du
    end
end

# aliases
alias = "command -v"
alias l "ls -lg"
alias la "l -lA"
alias lt "l --tree"
alias lta "lt -A"
alias lat "lt -A"
alias ld "l -l --sort newest"
alias ldr "ld -r"
alias ldt "ld -A"
alias ldtr "ldt -r"
alias ll "ls -lg --no-permissions --no-user --no-time --bytes --git"

{{ template "ravy_aliases_common.tmpl" (dict "shell" "fish") }}

# fish-specific aliases (not in common list)
alias pdips='podman ps -a --format "table {{"{{"}}.Names{{"}}"}}\t{{"{{"}}.Networks{{"}}"}}\t{{"{{"}}.Ports{{"}}"}}" | column -t'
alias scrall "systemctl --user list-unit-files --state=generated --no-legend | awk '{print \$1}' | xargs --no-run-if-empty systemctl --user restart"
alias scd "cd ~/.config/containers/systemd"

function jl --wraps="journalctl --user -xeu"
    if test (count $argv) -eq 0
        echo "Usage: jl <service_name>"
        return 1
    end
    journalctl --user -xeu $argv[1] -f
end

# docker commands
# `dc` is provided as an executable in $RAVY_HOME/bin (shared across shells)
alias dpri "docker image prune"
alias dprs "docker system prune --all"
alias dli "docker image list"
alias dls "docker system info"
alias drc "docker ps -f status=exited -q | xargs -n1 -I{} docker rm '{}'"
alias dri "docker images | grep '^<none>' | awk '{print \$3}' | xargs -n1 -I{} docker rmi '{}'"
alias dry "docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock moncho/dry"

# reset terminal buffer
alias reset 'command reset; stty sane; tput reset; echo -e "\033c"; clear; builtin cd -- $PWD'

function downcase-exts
    find . -type f -exec bash -c 'file="$1"; filename="${file%.*}"; ext="${file##*.}"; ext_lower=$(echo "$ext" | tr "[:upper:]" "[:lower:]"); if [ "$ext" != "$ext_lower" ]; then mv "$file" "$filename.$ext_lower"; fi' _ {} \;
end

# open-remote
test -n "$SSH_CONNECTION"
and alias open open-remote

# fish_title
set -x FISH_TITLE

function __fish_title_or_pwd
    if test -n "$FISH_TITLE"
        echo -s $FISH_TITLE
    else
        # Replace $HOME with "~"
        set realhome ~
        set -l tmp (string replace -r '^'"$realhome"'($|/)' '~$1' $PWD)
        echo $tmp
    end
end

function fish_title
    set -l cmd (status current-command)
    test "$cmd" != fish
    and echo -n "$cmd "
    __fish_title_or_pwd
end

# LOCAL overrides (not tracked)
test -f "$RAVY_HOME/custom/config.fish"; and source "$RAVY_HOME/custom/config.fish"

# ravy convenience commands
function ravy
    cd "$RAVY_HOME"
end

function ravycustom
    cd "$RAVY_HOME/custom"
end
alias ravyc ravycustom

function ravysource
    source "$HOME/.config/fish/config.fish"
end
alias ravys ravysource
